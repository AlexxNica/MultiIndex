<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>MultiIndex: How to index</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">MultiIndex
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">How to index </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#ALGO">Algorithm</a></li>
<li class="level1"><a href="#FORMATS">File formats</a></li>
<li class="level1"><a href="#EXAMPLE">Search sample</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="ALGO"></a>
Algorithm</h1>
<p>The idea of indexing algorithm is described in our <a href="http://download.yandex.ru/company/cvpr2012.pdf">paper</a>, we write only details of implementation here.<br/>
 <br/>
 Indexing consists of two stages: points space subdividing and calculating information for reranking. Because one can use different reranking approaches for the same space subdividing, after first stage algorithm saves on the HDD "coarse quantizations" for all points in the database. Coarse quantizations are just the identifiers of vocabulary items for all groups of dimensions. So if you already have file with coarse quantizations there is no need to calculate them again (miss the flag "&amp;ndash;build_coarse" in command line parameters).<br/>
 <br/>
 <a class="el" href="struct_multi_index.html">MultiIndex</a> consists of long onedimensional array and table with edges of clusters in this array. <a class="el" href="class_multi_indexer.html">MultiIndexer</a> is a C++ template by the type of the record in this array. So you can easy implement your own reranking approach by defining new structure NewRecordType and implementing function GetRecord&lt;NewRecordType&gt; for your structure.<br/>
 <br/>
 For indexing you should provide coarse vocabularies to build multiindex structure and fine vocabularies to calculate reranking information. We assume that these files are prepared outside this code (C++ is not the simplest way to create vocabularies).<br/>
</p>
<h1><a class="anchor" id="FORMATS"></a>
File formats</h1>
<ul>
<li><b>Database</b> <br/>
 Our code can handle only databases in <a href="http://corpus-texmex.irisa.fr">.bvecs</a> or <a href="http://corpus-texmex.irisa.fr">.fvecs</a> format.<br/>
</li>
<li><b>Coarse vocabularies</b><br/>
 Our code assumes that coarse vocabularies are in the next format:<br/>
 4 bytes(one int32) - number of items in each vocabulary (N)<br/>
 4 bytes(one int32) - dimension of item (d)<br/>
 4*N*d*M bytes(N*d*M floats) - vocabulary items one after another (M is the multiplicity of algorithm)<br/>
 <br/>
 Matlab script to build vocabularies <div class="fragment"><div class="line">clear all;</div>
<div class="line"></div>
<div class="line">all_data = bvecs_read(<span class="stringliteral">&#39;sift1M.bvecs&#39;</span>);</div>
<div class="line"></div>
<div class="line">all_data = single(all_data);</div>
<div class="line">vocabSize = 4096;</div>
<div class="line">% add implementation of K-means</div>
<div class="line">vocab1 = kmeans(single(all_data(1:end/2,:)),vocabSize);</div>
<div class="line">vocab2 = kmeans(single(all_data(end/2+1:end,:)),vocabSize);</div>
<div class="line"></div>
<div class="line">file = fopen([<span class="stringliteral">&#39;sift1M_4096_double_&#39;</span> num2str(vocabSize) <span class="stringliteral">&#39;.dat&#39;</span>], <span class="charliteral">&#39;w&#39;</span>);</div>
<div class="line">dim = size(vocab1, 1);</div>
<div class="line">sz = size(vocab1, 2);</div>
<div class="line">fwrite(file, dim, <span class="stringliteral">&#39;int32&#39;</span>);</div>
<div class="line">fwrite(file, sz, <span class="stringliteral">&#39;int32&#39;</span>);</div>
<div class="line">fwrite(file, vocab1, <span class="stringliteral">&#39;float&#39;</span>);</div>
<div class="line">fwrite(file, vocab2, <span class="stringliteral">&#39;float&#39;</span>);</div>
<div class="line">fclose(file);</div>
<div class="line">save([<span class="stringliteral">&#39;sift1M_4096_double_&#39;</span> num2str(vocabSize) <span class="stringliteral">&#39;.mat&#39;</span>], <span class="stringliteral">&#39;vocab1&#39;</span>, <span class="stringliteral">&#39;vocab2&#39;</span>);</div>
</div><!-- fragment --></li>
<li><b>Fine vocabularies</b><br/>
 Our code assumes that fine vocabularies are in the next format:<br/>
 4 bytes(one int32) - number of vocabularies (m)<br/>
 4 bytes(one int32) - number of items in each vocabulary (N)<br/>
 4 bytes(one int32) - dimension of item (d)<br/>
 4*N*d*m bytes(N*d*m floats) - vocabulary items one after another<br/>
</li>
</ul>
<h1><a class="anchor" id="EXAMPLE"></a>
Search sample</h1>
<p>To build invertered index for a set of points you should run "indexer_launcher" application with some command line parameters.</p>
<div class="fragment"><div class="line">--threads_count            - number of threads <span class="keywordflow">for</span> multi-threaded indexing</div>
<div class="line">--<a class="code" href="indexer__launcher_8cpp.html#a76e74046b0904e4b26f25c5fdd9f3ab6">multiplicity</a>             - number groups of dimensions points will be splitted to. Usually equals 2 or 4</div>
<div class="line">--<a class="code" href="indexer__launcher_8cpp.html#a3ac9d6c049de0ca2f44871dca63d4347">points_file</a>              - path to file with points database (should be in .bvecs or .fvecs format)</div>
<div class="line">--<a class="code" href="indexer__launcher_8cpp.html#a1e634836578ca163d1cda119acfbcafc">coarse_vocabs_file</a>       - path to file with coarse vocabs (format description)</div>
<div class="line">--<a class="code" href="indexer__launcher_8cpp.html#a975dce76db4dab6f67d0c2239239ac6e">fine_vocabs_file</a>         - path to file with fine vocabs <span class="keywordflow">for</span> reranking(format description)</div>
<div class="line">--input_point_type         - <span class="stringliteral">&quot;BVEC&quot;</span> or <span class="stringliteral">&quot;FVEC&quot;</span></div>
<div class="line">--<a class="code" href="indexer__launcher_8cpp.html#af95626628b3158ecd67b30ded5221428">points_count</a>             - number of points to index</div>
<div class="line">--space_dim                - number of dimensions in point</div>
<div class="line">--<a class="code" href="indexer__launcher_8cpp.html#a7c5bc2fd60474d132f70c581b86238f7">files_prefix</a>             - common prefix of future multiindex files</div>
<div class="line">--coarse_quantization_file - path to file with coarse quantizations</div>
<div class="line">--<a class="code" href="indexer__launcher_8cpp.html#afc9df9a336511af846444517e13b2104">metainfo_file</a>            - path to file with metainformation (deprecated, just write <span class="stringliteral">&quot;fake.txt&quot;</span>)</div>
<div class="line">--use_residuals            - reranking method flag (specify it <span class="keywordflow">if</span> you want to use residuals <span class="keywordflow">for</span> reranking and miss it <span class="keywordflow">if</span> you want to use initial points)</div>
<div class="line">--build_coarse             - <span class="keyword">this</span> flag indicate whether indexing algorithm should calculate points coarse quantizations</div>
</div><!-- fragment --><p>Windows users can try launch_indexer.bat script. It launches indexing of 1000000 provided points with provided vocabs. Unix users should just write a similar launch_indexer.sh script. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Aug 13 2012 19:52:27 for MultiIndex by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>

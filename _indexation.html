<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>MultiIndex: How to create a multi-index</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">MultiIndex
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">How to create a multi-index </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="ALGO"></a>
Algorithm</h2>
<p>The process of the multi-index construction is described in our <a href="http://download.yandex.ru/company/cvpr2012.pdf">paper</a>. Here we provide the details of the implementation.<br/>
 <br/>
 After the vocabularies are trained (see below), the index construction progress in two stages: assigning points to multi-index entries ("coarse quantization") and calculating information for reranking. Because one can use different reranking approaches for the same coarse quantization, the first stage of the algorithm saves the coarse quantizations for all points in the database to hard drive. These coarse quantizations are just the entry identifiers (e.g. codeword pairs). So if the file with coarse quantizations has already been produced there is no need to calculate them again (in this case, remove the flag --build_coarse from the command line parameters).<br/>
 <br/>
 In the CPU, a multi-index consists of a long onedimensional array containing the compressed points aligned by entries (i.e. a group of points belonging to the same entry is stored contiguously) and a table containing the starting index in the array for every entry of the multi-index. The class <a class="el" href="class_multi_indexer.html">MultiIndexer</a> is thus a C++ template by the type of the record in this array. In this way, you can easy implement your own reranking approach by defining new structure NewRecordType and implementing function GetRecord&lt;NewRecordType&gt; for your structure.<br/>
 <br/>
 For index contstruction you should provide coarse vocabularies for building the multi-index structure and fine vocabularies for calculating the reranking information (assuming that you are using the provided reranking procedure). We assume that these files are prepared outside this code (C++ is not the simplest way to create vocabularies, just for your reference we provide a MATLAB-script to create them below).<br/>
</p>
<h2><a class="anchor" id="FORMATS"></a>
File formats</h2>
<p>Our code uses the <a href="http://corpus-texmex.irisa.fr">.bvecs</a> and <a href="http://corpus-texmex.irisa.fr">.fvecs</a> file formats developed by INRIA LEAR and TEXMEX groups.</p>
<ul>
<li><b>Coarse vocabularies</b><br/>
 Our code assumes that coarse vocabularies are in the following format:<br/>
 4 bytes(one int32) - number of items in each vocabulary (N)<br/>
 4 bytes(one int32) - dimension of item (d)<br/>
 4*N*d*M bytes(N*d*M floats) - vocabulary items one after another (M is the multiplicity of algorithm)<br/>
 <br/>
 Matlab script to build coarse vocabularies <div class="fragment"><pre class="fragment">clear all;

all_data = bvecs_read(<span class="stringliteral">&#39;sift1M.bvecs&#39;</span>);

all_data = single(all_data);
vocabSize = 4096;
% add implementation of K-means
vocab1 = your_kmeans(single(all_data(1:end/2,:)),vocabSize);
vocab2 = your_kmeans(single(all_data(end/2+1:end,:)),vocabSize);

file = fopen([<span class="stringliteral">&#39;sift1M_double_4096_&#39;</span> num2str(vocabSize) <span class="stringliteral">&#39;.dat&#39;</span>], <span class="charliteral">&#39;w&#39;</span>);
dim = size(vocab1, 1);
sz = size(vocab1, 2);
fwrite(file, dim, <span class="stringliteral">&#39;int32&#39;</span>);
fwrite(file, sz, <span class="stringliteral">&#39;int32&#39;</span>);
fwrite(file, vocab1, <span class="stringliteral">&#39;float&#39;</span>);
fwrite(file, vocab2, <span class="stringliteral">&#39;float&#39;</span>);
fclose(file);
save([<span class="stringliteral">&#39;sift1M_double_4096_&#39;</span> num2str(vocabSize) <span class="stringliteral">&#39;.mat&#39;</span>], <span class="stringliteral">&#39;vocab1&#39;</span>, <span class="stringliteral">&#39;vocab2&#39;</span>);
</pre></div></li>
<li><b>Fine vocabularies</b><br/>
 Our code assumes that fine vocabularies are in the following format:<br/>
 4 bytes(one int32) - number of vocabularies (m)<br/>
 4 bytes(one int32) - number of items in each vocabulary (N)<br/>
 4 bytes(one int32) - dimension of item (d)<br/>
 4*N*d*m bytes(N*d*m floats) - vocabulary items one after another<br/>
</li>
</ul>
<p>Matlab script to build fine vocabularies (used <a href="http://www.vlfeat.org/">VlFeat</a> library) </p>
<div class="fragment"><pre class="fragment">clear all;
all_data = fvecs_read(<span class="stringliteral">&#39;sift1M.fvecs&#39;</span>);

vocabSize = 4096;
load([<span class="stringliteral">&#39;sift1M_double_&#39;</span> num2str(vocabSize) <span class="stringliteral">&#39;.mat&#39;</span>], <span class="stringliteral">&#39;vocab1&#39;</span>, <span class="stringliteral">&#39;vocab2&#39;</span>);

vocab1 = int32(vocab1);
vocab2 = int32(vocab2);
i1 = vl_ikmeanspush(all_data(1:end/2,:), vocab1);
i2 = vl_ikmeanspush(all_data(end/2+1:end,:), vocab2);  
residual = single(all_data)- single([vocab1(:,i1); vocab2(:,i2)]);
bytes_per_point = 8;    

D = size(residual,1) / bytes_per_point;
residual_vocab = cell(bytes_per_point,1);
dist = cell(bytes_per_point,1);
<span class="keywordflow">for</span> m = 1:bytes_per_point
    chunk = residual(D*m-D+1:D*m,:);
        % add implementation of K-means
    residual_vocab{m} = your_kmeans(chunk,256);
    dist{m} = vl_alldist2(residual_vocab{m});          
end

save([<span class="stringliteral">&#39;sift1M_double_4096_8.mat&#39;</span>],<span class="stringliteral">&#39;residual_vocab&#39;</span>,<span class="stringliteral">&#39;dist&#39;</span>);

file = fopen([<span class="stringliteral">&#39;sift1M_double_4096_8.dat&#39;</span>], <span class="charliteral">&#39;w&#39;</span>);
vocabs_count = size(residual_vocab, 1);
each_vocab_count = size(residual_vocab{1}, 2);
each_vocab_dim = size(residual_vocab{1}, 1);
fwrite(file, vocabs_count, <span class="stringliteral">&#39;int32&#39;</span>);
fwrite(file, each_vocab_count, <span class="stringliteral">&#39;int32&#39;</span>);
fwrite(file, each_vocab_dim, <span class="stringliteral">&#39;int32&#39;</span>);
<span class="keywordflow">for</span> i = 1:vocabs_count
    <span class="keywordflow">for</span> j = 1:each_vocab_count
        a = residual_vocab{i}(:,j);
        fwrite(file, a, <span class="stringliteral">&#39;float&#39;</span>);
    end
end
fclose(file);
</pre></div><h2><a class="anchor" id="EXAMPLE"></a>
Indexing sample</h2>
<p>To build an invertered index for a set of points you should run "indexer_launcher" application with some command line parameters.</p>
<div class="fragment"><pre class="fragment">--threads_count            - the number of threads to use <span class="keywordflow">for</span> the multi-threaded index construction
--<a class="code" href="indexer__launcher_8cpp.html#a76e74046b0904e4b26f25c5fdd9f3ab6">multiplicity</a>             - the number of groups of dimensions the vectors will be split into. Equals 2 or 4 <span class="keywordflow">for</span> the experiments in the paper.
--<a class="code" href="indexer__launcher_8cpp.html#a3ac9d6c049de0ca2f44871dca63d4347">points_file</a>              - the path to the file with the vector database (should be in .bvecs or .fvecs format)
--<a class="code" href="indexer__launcher_8cpp.html#a1e634836578ca163d1cda119acfbcafc">coarse_vocabs_file</a>       - the path to the file with the coarse vocabularies (see the format description above)
--<a class="code" href="indexer__launcher_8cpp.html#a975dce76db4dab6f67d0c2239239ac6e">fine_vocabs_file</a>         - the path to the file with fine vocabularies <span class="keywordflow">for</span> reranking (see the format description above)
--input_point_type         - <span class="stringliteral">&quot;BVEC&quot;</span> or <span class="stringliteral">&quot;FVEC&quot;</span>
--<a class="code" href="indexer__launcher_8cpp.html#af95626628b3158ecd67b30ded5221428">points_count</a>             - the number of points to index
--space_dim                - the space dimensionality (e.g. 128 <span class="keywordflow">for</span> SIFTs)
--<a class="code" href="indexer__launcher_8cpp.html#a7c5bc2fd60474d132f70c581b86238f7">files_prefix</a>             - the common prefix <span class="keywordflow">for</span> storing the multi-index files (used to control runs with different parameters)
--coarse_quantization_file - the path to the file with coarse quantizations
--<a class="code" href="indexer__launcher_8cpp.html#afc9df9a336511af846444517e13b2104">metainfo_file</a>            - the path to the file with metainformation (deprecated, just write <span class="stringliteral">&quot;fake.txt&quot;</span>)
--use_residuals            - the reranking method flag. Specify it <span class="keywordflow">if</span> you want to use residuals <span class="keywordflow">for</span> reranking (Multi-D-ADC) and omit it if you want to use initial points (Multi-ADC)
--build_coarse             - specify this flag if you want to recompute coarse quantizations (otherwise, will use the previously computed, if available)
</pre></div><p>Windows users can try launch_indexer.bat script. It launches indexing of the <a href="http://corpus-texmex.irisa.fr/">ANN_SIFT1M dataset</a> using the provided vocabularies. Unix users should just write a similar launch_indexer.sh script. </p>
</div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Mon Oct 22 2012 14:33:14 for MultiIndex by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
